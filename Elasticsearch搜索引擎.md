---
title: Elasticsearch搜索引擎
date: 2022-02-06 21:59:48
categories: 大数据
tags: Elasticsearch 
---

冲冲冲! ! !

# 一些前期概念

## 全文检索

> 首先要明白几个大数据的概念: 结构化数据、半结构化数据、非结构化数据
>
> **结构化数据:** 听名字就知道, 具有固定格式或有限长度的数据, 比如**关系型数据库中数据表里的数据** 。
>
> **半结构化数据:** 具有可识别的模式并可以解析的文本数据文件， 比如**XML数据文件** ..
>
> **非结构化数据**，没有固定结构的数据， 通常保存为不同类型的文件， 比如**文本文档、 图片、 视频**等, 一般存储为二进制的数据格式。
>
> 针对非结构化数据, 产生了一套特殊的搜索: 顺序搜索(太慢, 一般不考虑.), **全文检索**.
>
> **全文检索:** **基本思路: 我们可以把非结构化数据想办法弄得有一定结构**；将非结构化数据中的**一部分信息提取出来**，重新组织，使其变得有一定结构，然后对这些有一定结构的数据进行搜索，从而达到搜索相对较快的目的。**这部分从非结构化数据中提取出的然后重新组织的信息，我们称之索引**。**这种先建立索引, 在对索引进行搜索的过程就叫全文检索.**
>
> **全文搜索引擎: **根据百度百科中的定义，全文搜索引擎是目前广泛应用的主流搜索引擎。**它的工作原理是计算机索引程序通过扫描文章中的每一个词，对每一个词建立一个索引，指明该词在文章中出现的次数和位置，当用户查询时，检索程序就根据事先建立的索引进行查找，并将查找的结果反馈给用户**

**分布式**：一个业务分拆多个子业务，部署在不同的服务器上.

**微服务**: 微服务与分布式的细微差别是，微服务的应用不一定是分散在多个服务器上，他也可以是同一个服务器。

**集群**：同一个业务，部署在多个服务器上.

**SOA**：业务系统分解为多个组件，让每个组件都独立提供离散，自治，可复用的服务能力，通过服务的组合和编排来实现上层的业务流程.

## lucene 全文检索流程

由于ES底层基于lucene, 下面看一下lucene的全文检索过程: 

![](https://i.bmp.ovh/imgs/2022/02/d2a4c469e88d9025.png)

![](https://s3.bmp.ovh/imgs/2022/02/e86efab6db42d678.png)

**总结: 全文检索过程分为索引, 搜索两个过程: **

* 索引
  1. **获得文档**: 从关系数据库中、互联网上、文件系统采集源数据(要搜索的目标信息)
  2. **构建文档对象**: 每个原始文档创建一个Document对象, 每个Document对象中包含多个域(field), 域中保存的就是原始文档数据(域的名称, 域的值), 每个文档都有一个唯一的编号, 就是文档id.
  3. **分析文档**: 就是分词的过程.
  4. **创建索引**: 基于关键词列表创建一个索引. 保存到索引库中.索引包含: 索引, document对象, 关键词和文档的对应关系.(通过词语找文档, 这种索引的结构叫做倒排索引文档).
* 搜索
  1. 用户查询接口
  2. 把关键词封装成一个查询对象(要查询的域, 要搜索的关键字)
  3. 执行查询

## 全文检索框架介绍

市面上全文检索的框架很多，较早期的一个框架就是 lucene，基本上所有的全文检索的工作都交给 lucene 来实现，但是 lucene 最大的弊端就是 API 太原生，没有经过任何封装，不太好使用。所以后来出现一个叫做 solr 的框架，它也是基于 lucene 进行改造封装和包装，将服务端单独提取出来，客户端进行请求即可。另外一个框架就是大名鼎鼎的 elasticsearch 了，es 也是一个基于 lucene 打造的全文检索的框架，且一经推出就迅速被市场认可，市场占有率越来越多，现在首选的全文检索的框架基本就是 ES 了。

# ELK学习

1. 全文检索需求: 因为数据库已经解决不潦海量数据的快速查询, 所以引入了全文检索, 最原生的是lucene, 经过封装出现solr, solr有一个缺点, 在建立索引的时候, 搜索性能下降, 后来出现es, 性能最高.
2. ELK日志协议栈
   - E: elasticsearch 是一个实时的分布式搜索和分析引擎, 它可以用于全文搜索, 结构化搜索以及分析, 基于lucene.
   
     主要特点: ① 实时分析, ② 分布式实时文件存储, 并将每一个字段都编入索引, ③ 文档导向, 所有的对象全部是文档, ④ 高可用性, 易扩展, 支持集群(Cluster), 分片和复制(Shards 和 Replicas). ⑤ 接口友好, 支持JSON.

   - L: logstash 日志数据收集框架( 是一个具有实时渠道能力的数据收集引擎 ), 类似于flume.
   
     主要特点: ① 几乎可以访问任何数据, ② 可以和多种外部应用结合, ③ 支持弹性拓展, 主要有三个部分组成: Shipper --> 发送日志数据, Broker --> 收集数据, 缺省内置 Redis,  Indexer --> 数据写入.
   
   - K: kibana 报表展示工具., 为ES提供分析和可视化的Web平台,  类似于echarts.
   
   **三者之间的关系**: 使用logstash采集数据, 采集的数据全部都存储到es里面去, 使用kibanna展示es索引库当中的数据.
   

# Elasticsearch 

## 1.什么是Elasticsearch 

> Elasticsearch, 简称es, es是一个开源的高拓展的分布式全文检索引擎, 它可以近乎实时的存储, 检索数据: 本身拓展性很好, 可以拓展到上百台服务器, 处理PB级别的数据, es 也是用 java 开发并使用Lucene作为其核心来实现所有索引和搜索的功能, 但是他的目的是通过简单的 ReSTful API 来隐藏Lucene的复杂性, 从而让全文搜索变得简单.

## 2. Elasticsearch 对比Solr

* Solr利用Zookeeper 进行分布式管理, 而 Elaticsearch 自身带有分布式协调管理功能;
* Solr 支持更多格式的数据, 而Elasticsearch仅支持Json文件格式;
* Solr官方提供的功能更多, 而Elasticsearch本身注重于核心功能, 高级功能由第三方插件提供;
* Solr 在传统的搜索应用中变现好于 Elasticsearch, 但在处理实时搜索应用时效率明显低于Elasticsearch;

## 3. Elasticsearch架构图以及基本概念(术语)

### 1. es概述

> Elasticsearch是面向文档(document), 这意味着它可以存储整个对象或文档, 然而它不仅仅是存储, 还会索引每个文档的内容使之可以被搜索, 在Elasticsearch中, 你可以对文档(而非成行成列的数据) 进行索引, 搜索, 排序, 过滤.

**Elasticsearch 比传统关系型数据库如下:** 

**Relational DB ----> Databases ----> Tables ----> Rows ----> Columns.**

**Elasticsearch ----> Indices ----> ( Types ) -----> Documents -----> Fields.**



### 2. ES架构模块

![](https://s3.bmp.ovh/imgs/2022/02/b91928089260f4a3.png)
**Gateway**: 是ES用来存储索引的文件系统, 支持多种类型, 在Gateway中, ES默认先把索引存储在内存中, 然后当内存满的时候, 在持久化到Gateway里, 当ES集群关闭或重启的时候, 他就会从Gateway里去读取索引数据, 比如LocalFileSystem和HDFS, AS3等.

**DistributedLucene Directory**: 是一个分布式的lucene框架. 负责管理这些索引文件, 包括数据的读取, 写入, 以及索引的添加和合并.

**River**: 代表数据源, 是以插件的形式存在于ES中.

**Mapping**: 映射模块, 非常类似于静态语言中的数据类型. 比如我们声明一个int类型的变量, 那以后这个变量只能存储int类型的数据. 比如我们声明一个double类型的mapping字段, 则只能存储double类型的数据. Mapping 不仅仅是告诉ES, 哪个字段是哪种类型, 还能告诉ES如何来索引数据, 以及数据是否被索引到等.

**Disvcovery**: 是ES的节点发现模块, 不同机器上的ES节点要组成集群需要进行消息通信, 集群内布需要选举master节点, 这些工作都是由Discover模块完成. 支持多种发现机制, 如Zen, EC2, gce, Azure.

**Scripting**: 即脚本语言。包括很多，这里不多赘述。如mvel、js、python等。

**Transport**: 代表ES内部节点, 代表集群的客户端交互, 包括一些Http协议等.

**JMX**: 监控, 是java的管理框架, 用来管理ES应用.

**3rd plugins**，代表第三方插件。

**Java(Netty)**，是开发框架。

**RESTful Style API**: 提供给用户的接口, 可以通过RESTful接口和ES集群进行交互.

### 3.ES核心概念

1. 索引 index

2. 类型 type

3. 字段  Field

4. 映射  Mapping

5. 文档  document

6. 集群  cluster

7. 节点  node

8. 分片和复制  shards & replacas

   



* 